services:
  robot-orchestrator:
    build:
      context: ./controller
      dockerfile: Dockerfile
    container_name: robot-orchestrator
    restart: unless-stopped
    ports:
      - "8080:8080"

    environment:
      WEB_PORT: "8080"
      RERUN_URL: "http://lerobot-drive:9877/"

      # Zenoh peers (service names)
      ZENOH_CONNECT_ENDPOINTS: "lerobot-drive:7447,whisper:7447,tts:7447"

      # audio bridge topics
      ZENOH_KEY_AUDIO_IN: "AUDIO_IN"
      ZENOH_KEY_AUDIO_OUT: "AUDIO_OUT"

      # agent config
      MODEL_NAME: "generic.qwen3:4b-instruct"
      OPENAI_API_KEY: ""
      OLLAMA_URL: "http://ollama:11434"
      ROBOT_MCP_URL: "http://lerobot-drive:9988"
      IMAGE_DESCRIPTION_MCP_URL: "http://image-description-mcp:9988"

    depends_on:
      - ollama
      - lerobot-drive
      - whisper
      - tts

  lerobot-drive:
    build:
      context: ./lerobot-driver
      dockerfile: Dockerfile
    container_name: lerobot-drive
    restart: unless-stopped
    privileged: true

    devices:
      - "${CAMERA_DEV:-/dev/null}:${CAMERA_DEV:-/dev/null}"

    volumes:
      - ./lerobot-driver/calibration.json:/config/calibration.json:ro
      - /dev:/dev
      - /run/udev:/run/udev:ro

    environment:
      ZENOH_CONNECT_ENDPOINTS: "robot-orchestrator:7447,whisper:7447,tts:7447"
      CALIBRATION_PATH: "/config/calibration.json"
      LEROBOT_SERVER_ADDRESS: "10.0.0.50:50051"
      MCP_PORT: "9988"

      # rerun viewer server ports (if you implemented init_rerun_viewer_server)
      RERUN_GRPC_PORT: "9876"
      RERUN_HTTP_PORT: "9877"

    ports:
      - "9988:9988"
      - "9876:9876"
      - "9877:9877"
      - "7447:7447"

  whisper:
    build:
      context: ./whisper
      dockerfile: Dockerfile
    container_name: whisper
    restart: unless-stopped

    environment:
      ZENOH_CONNECT_ENDPOINTS: "robot-orchestrator:7447,lerobot-drive:7447,tts:7447"
      ZENOH_AUDIO_IN_KEY: "AUDIO_IN"
      ZENOH_TEXT_OUT_KEY: "TRANSCRIPT_TEXT"

      # browser sends 24kHz int16 PCM
      AUDIO_SR: "24000"

      WHISPER_MODEL: "/models/ggml-tiny.en.bin"

      SR: "16000"
      GAP_MS: "200"
      MIN_UTTER_MS: "250"
      MAX_UTTER_MS: "5000"
      VAD_RMS_TH: "0.010"
      BEST_OF: "1"

    volumes:
      - ./whisper/models:/models:ro

  tts:
    build:
      context: ./tts
      dockerfile: Dockerfile
    container_name: tts
    restart: unless-stopped

    environment:
      ZENOH_CONNECT_ENDPOINTS: "robot-orchestrator:7447,lerobot-drive:7447,whisper:7447"
      ZENOH_TTS_TEXT_KEY: "TRANSCRIPT_TEXT"
      ZENOH_TTS_AUDIO_KEY: "AUDIO_OUT"

      # match web UI sampleRate
      TTS_SR: "24000"

      # optional tuning
      TTS_RATE: "150"
      TTS_VOLUME: "1.0"
      # TTS_VOICE: ""

  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama

volumes:
  ollama_data:
